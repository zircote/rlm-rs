name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.sha256.outputs.sha256 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

      - name: Calculate SHA256
        id: sha256
        env:
          TAG_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          curl -sL "https://github.com/${REPO}/archive/refs/tags/${TAG_NAME}.tar.gz" -o release.tar.gz
          SHA256=$(shasum -a 256 release.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew formula
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          script: |
            const version = '${{ needs.release.outputs.version }}';
            const sha256 = '${{ needs.release.outputs.sha256 }}';

            const formula = `class RlmRs < Formula
              desc "Recursive Language Model CLI for Claude Code - handles long-context tasks via chunking"
              homepage "https://github.com/zircote/rlm-rs"
              url "https://github.com/zircote/rlm-rs/archive/refs/tags/v${version}.tar.gz"
              sha256 "${sha256}"
              license "MIT"
              head "https://github.com/zircote/rlm-rs.git", branch: "main"

              depends_on "rust" => :build

              def install
                system "cargo", "install", *std_cargo_args
              end

              test do
                assert_match "rlm-rs #{version}", shell_output("#{bin}/rlm-rs --version")

                # Test init command
                system "#{bin}/rlm-rs", "init"
                assert_predicate testpath/".rlm/rlm-state.db", :exist?
              end
            end
            `;

            // Get current file to get its SHA
            const { data: currentFile } = await github.rest.repos.getContent({
              owner: 'zircote',
              repo: 'homebrew-tap',
              path: 'Formula/rlm-rs.rb',
            });

            // Update the formula
            await github.rest.repos.createOrUpdateFileContents({
              owner: 'zircote',
              repo: 'homebrew-tap',
              path: 'Formula/rlm-rs.rb',
              message: `chore: bump rlm-rs to v${version}`,
              content: Buffer.from(formula).toString('base64'),
              sha: currentFile.sha,
            });

            console.log(`Updated rlm-rs formula to v${version}`);
